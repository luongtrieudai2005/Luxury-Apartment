{% extends "base.html" %}
{% block title %}Quản lý đặt phòng{% endblock %}

{% block content %}
<h3 class="mb-4">Quản lý đặt phòng</h3>

<!-- Thanh tìm kiếm và lọc -->
<div class="card p-3 shadow-sm mb-4">
  <div class="row g-3">
    <div class="col-md-4">
      <input type="text" class="form-control" id="searchBooking" placeholder="Tìm kiếm khách hàng...">
    </div>
    <div class="col-md-3">
      <select class="form-select" id="filterStatus">
        <option value="">Tất cả trạng thái</option>
        <option value="pending">Chờ xác nhận</option>
        <option value="confirmed">Đã xác nhận</option>
        <option value="cancelled">Đã hủy</option>
      </select>
    </div>
    <div class="col-md-3">
      <select class="form-select" id="sortBy">
        <option value="date_desc">Ngày mới nhất</option>
        <option value="date_asc">Ngày cũ nhất</option>
        <option value="name_asc">Tên A-Z</option>
        <option value="name_desc">Tên Z-A</option>
      </select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addBookingModal">
        <i class="bi bi-plus-lg"></i> Thêm đặt phòng
      </button>
    </div>
  </div>
</div>

<!-- Bảng danh sách đặt phòng -->
<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Mã đặt phòng</th>
          <th>Khách hàng</th>
          <th>Phòng</th>
          <th>Ngày đặt</th>
          <th>Ngày nhận phòng</th>
          <th>Trạng thái</th>
          <th>Thao tác</th>
        </tr>
      </thead>
      <tbody id="bookingTableBody">
        <tr data-booking-id="1" data-status="pending">
          <td><strong>#BK001</strong></td>
          <td>Nguyễn Văn A<br><small class="text-muted">0901234567</small></td>
          <td>Phòng 101<br><small class="text-muted">22L Quận 7</small></td>
          <td>20/11/2025</td>
          <td>01/12/2025</td>
          <td><span class="badge bg-warning">Chờ xác nhận</span></td>
          <td>
            <button class="btn btn-sm btn-success" onclick="confirmBooking(1)">
              <i class="bi bi-check-lg"></i>
            </button>
            <button class="btn btn-sm btn-info" onclick="viewBooking(1)">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="cancelBooking(1)">
              <i class="bi bi-x-lg"></i>
            </button>
          </td>
        </tr>
        <tr data-booking-id="2" data-status="confirmed">
          <td><strong>#BK002</strong></td>
          <td>Trần Thị B<br><small class="text-muted">0912345678</small></td>
          <td>Phòng 201<br><small class="text-muted">223 Quận 1</small></td>
          <td>18/11/2025</td>
          <td>25/11/2025</td>
          <td><span class="badge bg-success">Đã xác nhận</span></td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="createContract(2)">
              <i class="bi bi-file-text"></i> Tạo HĐ
            </button>
            <button class="btn btn-sm btn-info" onclick="viewBooking(2)">
              <i class="bi bi-eye"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal thêm đặt phòng -->
<div class="modal fade" id="addBookingModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thêm đặt phòng mới</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addBookingForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Họ và tên *</label>
              <input type="text" class="form-control" name="customer_name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Số điện thoại *</label>
              <input type="tel" class="form-control" name="phone" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="email">
            </div>
            <div class="col-md-6">
              <label class="form-label">CCCD/CMND *</label>
              <input type="text" class="form-control" name="id_number" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Nhà *</label>
              <select class="form-select" name="house" required onchange="loadRooms(this.value)">
                <option value="">Chọn nhà</option>
                <option value="1">22L Quận 7</option>
                <option value="2">223 Quận 1</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Phòng *</label>
              <select class="form-select" name="room" required>
                <option value="">Chọn phòng</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Ngày nhận phòng *</label>
              <input type="date" class="form-control" name="check_in_date" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Thời hạn thuê (tháng) *</label>
              <input type="number" class="form-control" name="duration" min="1" value="6" required>
            </div>
            <div class="col-12">
              <label class="form-label">Ghi chú</label>
              <textarea class="form-control" name="notes" rows="2"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" onclick="submitBooking()">Lưu đặt phòng</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal xem chi tiết -->
<div class="modal fade" id="viewBookingModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chi tiết đặt phòng #<span id="detailBookingId"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="bookingDetailContent">
        <!-- Content sẽ được load động -->
      </div>
    </div>
  </div>
</div>

<script>
// Demo data
const bookings = {
  1: {
    id: 'BK001',
    customer: 'Nguyễn Văn A',
    phone: '0901234567',
    email: 'nguyenvana@email.com',
    id_number: '001234567890',
    house: '22L Quận 7',
    room: 'Phòng 101',
    check_in_date: '01/12/2025',
    duration: 6,
    status: 'pending',
    notes: 'Khách yêu cầu dọn phòng trước khi nhận'
  },
  2: {
    id: 'BK002',
    customer: 'Trần Thị B',
    phone: '0912345678',
    email: 'tranthib@email.com',
    id_number: '009876543210',
    house: '223 Quận 1',
    room: 'Phòng 201',
    check_in_date: '25/11/2025',
    duration: 12,
    status: 'confirmed',
    notes: ''
  }
};

const rooms = {
  '1': [
    {value: '101', text: 'Phòng 101 - 5tr/tháng'},
    {value: '102', text: 'Phòng 102 - 5.5tr/tháng'}
  ],
  '2': [
    {value: '201', text: 'Phòng 201 - 7tr/tháng'},
    {value: '202', text: 'Phòng 202 - 7.5tr/tháng'}
  ]
};

function loadRooms(houseId) {
  const roomSelect = document.querySelector('select[name="room"]');
  roomSelect.innerHTML = '<option value="">Chọn phòng</option>';
  
  if (rooms[houseId]) {
    rooms[houseId].forEach(room => {
      const option = document.createElement('option');
      option.value = room.value;
      option.textContent = room.text;
      roomSelect.appendChild(option);
    });
  }
}

function submitBooking() {
  const form = document.getElementById('addBookingForm');
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }
  
  alert('Đặt phòng thành công! (Demo)');
  bootstrap.Modal.getInstance(document.getElementById('addBookingModal')).hide();
  form.reset();
}

function confirmBooking(id) {
  if (confirm('Xác nhận đặt phòng này?')) {
    alert(`Đã xác nhận đặt phòng #BK${String(id).padStart(3, '0')}`);
    location.reload();
  }
}

function viewBooking(id) {
  const booking = bookings[id];
  const statusBadge = booking.status === 'pending' ? 'bg-warning' : 
                      booking.status === 'confirmed' ? 'bg-success' : 'bg-danger';
  const statusText = booking.status === 'pending' ? 'Chờ xác nhận' : 
                     booking.status === 'confirmed' ? 'Đã xác nhận' : 'Đã hủy';
  
  document.getElementById('detailBookingId').textContent = booking.id;
  document.getElementById('bookingDetailContent').innerHTML = `
    <div class="row g-3">
      <div class="col-md-6">
        <strong>Khách hàng:</strong> ${booking.customer}
      </div>
      <div class="col-md-6">
        <strong>Số điện thoại:</strong> ${booking.phone}
      </div>
      <div class="col-md-6">
        <strong>Email:</strong> ${booking.email}
      </div>
      <div class="col-md-6">
        <strong>CCCD:</strong> ${booking.id_number}
      </div>
      <div class="col-md-6">
        <strong>Nhà:</strong> ${booking.house}
      </div>
      <div class="col-md-6">
        <strong>Phòng:</strong> ${booking.room}
      </div>
      <div class="col-md-6">
        <strong>Ngày nhận phòng:</strong> ${booking.check_in_date}
      </div>
      <div class="col-md-6">
        <strong>Thời hạn:</strong> ${booking.duration} tháng
      </div>
      <div class="col-12">
        <strong>Trạng thái:</strong> <span class="badge ${statusBadge}">${statusText}</span>
      </div>
      ${booking.notes ? `<div class="col-12"><strong>Ghi chú:</strong> ${booking.notes}</div>` : ''}
    </div>
  `;
  
  new bootstrap.Modal(document.getElementById('viewBookingModal')).show();
}

function cancelBooking(id) {
  if (confirm('Hủy đặt phòng này?')) {
    alert(`Đã hủy đặt phòng #BK${String(id).padStart(3, '0')}`);
    location.reload();
  }
}

function createContract(id) {
  if (confirm('Tạo hợp đồng thuê từ đặt phòng này?')) {
    window.location.href = `/contract-management?from_booking=${id}`;
  }
}

// Search và Filter
document.getElementById('searchBooking')?.addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const rows = document.querySelectorAll('#bookingTableBody tr');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
});

document.getElementById('filterStatus')?.addEventListener('change', function(e) {
  const status = e.target.value;
  const rows = document.querySelectorAll('#bookingTableBody tr');
  
  rows.forEach(row => {
    if (!status || row.dataset.status === status) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
});
</script>

{% endblock %}