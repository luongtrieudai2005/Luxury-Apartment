{% extends "base.html" %}
{% block title %}Quản lý người dùng & Phân quyền{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h3 class="mb-1">Quản lý người dùng & Phân quyền</h3>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{{ url_for('system_config') }}">Quản trị hệ thống</a></li>
        <li class="breadcrumb-item active">Người dùng</li>
      </ol>
    </nav>
  </div>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
    <i class="bi bi-plus-lg"></i> Thêm người dùng
  </button>
</div>

<!-- Thống kê -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card border-primary">
      <div class="card-body">
        <h6 class="text-muted mb-1">Tổng người dùng</h6>
        <h3 class="text-primary mb-0">48</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-success">
      <div class="card-body">
        <h6 class="text-muted mb-1">Đang hoạt động</h6>
        <h3 class="text-success mb-0">42</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-warning">
      <div class="card-body">
        <h6 class="text-muted mb-1">Bị khóa</h6>
        <h3 class="text-warning mb-0">6</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-info">
      <div class="card-body">
        <h6 class="text-muted mb-1">Admin</h6>
        <h3 class="text-info mb-0">3</h3>
      </div>
    </div>
  </div>
</div>

<!-- Tìm kiếm và lọc -->
<div class="card p-3 shadow-sm mb-4">
  <div class="row g-3">
    <div class="col-md-4">
      <input type="text" class="form-control" id="searchUser" placeholder="Tìm kiếm theo tên, email...">
    </div>
    <div class="col-md-3">
      <select class="form-select" id="filterRole">
        <option value="">Tất cả vai trò</option>
        <option value="admin">Admin</option>
        <option value="nhanvien">Nhân viên</option>
        <option value="khach">Khách hàng</option>
      </select>
    </div>
    <div class="col-md-3">
      <select class="form-select" id="filterStatus">
        <option value="">Tất cả trạng thái</option>
        <option value="active">Đang hoạt động</option>
        <option value="locked">Bị khóa</option>
      </select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-outline-secondary w-100" onclick="exportUsers()">
        <i class="bi bi-download"></i> Xuất Excel
      </button>
    </div>
  </div>
</div>

<!-- Bảng danh sách người dùng -->
<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>Tên đăng nhập</th>
          <th>Họ tên</th>
          <th>Email</th>
          <th>Vai trò</th>
          <th>Trạng thái</th>
          <th>Ngày tạo</th>
          <th>Thao tác</th>
        </tr>
      </thead>
      <tbody id="userTableBody">
        <tr data-user-id="1" data-role="admin" data-status="active">
          <td><input type="checkbox" class="user-checkbox"></td>
          <td><strong>admin</strong></td>
          <td>Nguyễn Văn Admin</td>
          <td>admin@system.com</td>
          <td><span class="badge bg-danger">Admin</span></td>
          <td><span class="badge bg-success">Hoạt động</span></td>
          <td>01/01/2024</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-info" onclick="viewUser(1)" title="Xem">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-warning" onclick="editUser(1)" title="Sửa">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-secondary" onclick="lockUser(1)" title="Khóa">
                <i class="bi bi-lock"></i>
              </button>
            </div>
          </td>
        </tr>
        
        <tr data-user-id="2" data-role="nhanvien" data-status="active">
          <td><input type="checkbox" class="user-checkbox"></td>
          <td><strong>nhanvien01</strong></td>
          <td>Trần Thị B</td>
          <td>tranthib@company.com</td>
          <td><span class="badge bg-warning">Nhân viên</span></td>
          <td><span class="badge bg-success">Hoạt động</span></td>
          <td>15/02/2024</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-info" onclick="viewUser(2)">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-warning" onclick="editUser(2)">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-secondary" onclick="lockUser(2)">
                <i class="bi bi-lock"></i>
              </button>
              <button class="btn btn-danger" onclick="deleteUser(2)">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        
        <tr data-user-id="3" data-role="khach" data-status="active">
          <td><input type="checkbox" class="user-checkbox"></td>
          <td><strong>khach01</strong></td>
          <td>Lê Văn C</td>
          <td>levanc@email.com</td>
          <td><span class="badge bg-primary">Khách hàng</span></td>
          <td><span class="badge bg-success">Hoạt động</span></td>
          <td>20/03/2024</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-info" onclick="viewUser(3)">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-warning" onclick="editUser(3)">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-secondary" onclick="lockUser(3)">
                <i class="bi bi-lock"></i>
              </button>
              <button class="btn btn-danger" onclick="deleteUser(3)">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        
        <tr data-user-id="4" data-role="khach" data-status="locked">
          <td><input type="checkbox" class="user-checkbox"></td>
          <td><strong>khach02</strong></td>
          <td>Phạm Thị D</td>
          <td>phamthid@email.com</td>
          <td><span class="badge bg-primary">Khách hàng</span></td>
          <td><span class="badge bg-secondary">Bị khóa</span></td>
          <td>10/04/2024</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-info" onclick="viewUser(4)">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-success" onclick="unlockUser(4)" title="Mở khóa">
                <i class="bi bi-unlock"></i>
              </button>
              <button class="btn btn-danger" onclick="deleteUser(4)">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <!-- Pagination -->
  <div class="card-footer d-flex justify-content-between align-items-center">
    <div>Hiển thị 1-4 của 48 người dùng</div>
    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item disabled"><a class="page-link" href="#">Trước</a></li>
        <li class="page-item active"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item"><a class="page-link" href="#">Sau</a></li>
      </ul>
    </nav>
  </div>
</div>

<!-- Modal Thêm người dùng -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thêm người dùng mới</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addUserForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Tên đăng nhập *</label>
              <input type="text" class="form-control" name="username" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Mật khẩu *</label>
              <input type="password" class="form-control" name="password" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Họ và tên *</label>
              <input type="text" class="form-control" name="fullname" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Email *</label>
              <input type="email" class="form-control" name="email" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Số điện thoại</label>
              <input type="tel" class="form-control" name="phone">
            </div>
            <div class="col-md-6">
              <label class="form-label">Vai trò *</label>
              <select class="form-select" name="role" required>
                <option value="">Chọn vai trò</option>
                <option value="admin">Admin</option>
                <option value="nhanvien">Nhân viên</option>
                <option value="khach">Khách hàng</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Quyền truy cập</label>
              <div class="row g-2">
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="permQuanLyNha">
                    <label class="form-check-label" for="permQuanLyNha">Quản lý nhà</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="permHopDong">
                    <label class="form-check-label" for="permHopDong">Quản lý hợp đồng</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="permDichVu">
                    <label class="form-check-label" for="permDichVu">Quản lý dịch vụ</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="permBaoCao">
                    <label class="form-check-label" for="permBaoCao">Xem báo cáo</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="permThanhToan">
                    <label class="form-check-label" for="permThanhToan">Quản lý thanh toán</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="permCauHinh">
                    <label class="form-check-label" for="permCauHinh">Cấu hình hệ thống</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="sendWelcomeEmail" checked>
                <label class="form-check-label" for="sendWelcomeEmail">
                  Gửi email chào mừng
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" onclick="saveUser()">
          <i class="bi bi-save"></i> Tạo tài khoản
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Select all checkboxes
document.getElementById('selectAll')?.addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('.user-checkbox');
  checkboxes.forEach(cb => cb.checked = this.checked);
});

// Search
document.getElementById('searchUser')?.addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const rows = document.querySelectorAll('#userTableBody tr');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
});

// Filter by role
document.getElementById('filterRole')?.addEventListener('change', function(e) {
  const role = e.target.value;
  const rows = document.querySelectorAll('#userTableBody tr');
  
  rows.forEach(row => {
    if (!role || row.dataset.role === role) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
});

// Filter by status
document.getElementById('filterStatus')?.addEventListener('change', function(e) {
  const status = e.target.value;
  const rows = document.querySelectorAll('#userTableBody tr');
  
  rows.forEach(row => {
    if (!status || row.dataset.status === status) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
});

function saveUser() {
  const form = document.getElementById('addUserForm');
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }
  
  alert('Đã tạo tài khoản người dùng mới! (Demo)');
  bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
  form.reset();
}

function viewUser(id) {
  alert(`Xem chi tiết người dùng #${id} (Demo)`);
}

function editUser(id) {
  alert(`Chỉnh sửa người dùng #${id} (Demo)`);
}

function lockUser(id) {
  if (confirm('Khóa tài khoản này?')) {
    alert(`Đã khóa người dùng #${id} (Demo)`);
    location.reload();
  }
}

function unlockUser(id) {
  if (confirm('Mở khóa tài khoản này?')) {
    alert(`Đã mở khóa người dùng #${id} (Demo)`);
    location.reload();
  }
}

function deleteUser(id) {
  if (confirm('Xóa người dùng này? Hành động không thể hoàn tác!')) {
    alert(`Đã xóa người dùng #${id} (Demo)`);
    location.reload();
  }
}

function exportUsers() {
  alert('Đang xuất danh sách người dùng ra Excel... (Demo)');
}
</script>

{% endblock %}