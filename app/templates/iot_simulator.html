{% extends "base.html" %}
{% block title %}IoT Simulator - Demo & Test{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h3 class="mb-1">üî¨ IoT Simulator - Demo & Testing</h3>
    <p class="text-muted mb-0">C√¥ng c·ª• m√¥ ph·ªèng c·∫£m bi·∫øn IoT ƒë·ªÉ test h·ªá th·ªëng</p>
  </div>
  <div class="btn-group">
    <button class="btn btn-success" onclick="startAllSimulators()">
      <i class="bi bi-play-fill"></i> Ch·∫°y t·∫•t c·∫£
    </button>
    <button class="btn btn-danger" onclick="stopAllSimulators()">
      <i class="bi bi-stop-fill"></i> D·ª´ng t·∫•t c·∫£
    </button>
  </div>
</div>

<div class="alert alert-info mb-4">
  <i class="bi bi-info-circle"></i> 
  <strong>L∆∞u √Ω:</strong> ƒê√¢y l√† c√¥ng c·ª• demo ƒë·ªÉ test h·ªá th·ªëng IoT. 
  D·ªØ li·ªáu ƒë∆∞·ª£c t·∫°o ng·∫´u nhi√™n v√† g·ª≠i ƒë·∫øn API endpoint.
</div>

<div class="row g-4">
  <!-- Simulator 1: C·∫£m bi·∫øn ƒëi·ªán -->
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-warning text-dark">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-lightning-charge"></i> C·∫£m bi·∫øn ƒêi·ªán
          </h5>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="electricSimulator" onchange="toggleSimulator('electric')">
            <label class="form-check-label">B·∫≠t/T·∫Øt</label>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label small">Device ID</label>
            <input type="text" class="form-control form-control-sm" value="ESP32-E001" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label small">Ph√≤ng</label>
            <select class="form-select form-select-sm">
              <option>Ph√≤ng 101</option>
              <option>Ph√≤ng 102</option>
              <option>Ph√≤ng 201</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label small">Gi√° tr·ªã (kW)</label>
            <input type="number" class="form-control form-control-sm" id="electricValue" value="2.5" step="0.1">
          </div>
          <div class="col-md-6">
            <label class="form-label small">T·∫ßn su·∫•t (gi√¢y)</label>
            <input type="number" class="form-control form-control-sm" id="electricInterval" value="5" min="1">
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label small">Ch·∫ø ƒë·ªô m√¥ ph·ªèng</label>
          <select class="form-select form-select-sm" id="electricMode">
            <option value="normal">B√¨nh th∆∞·ªùng</option>
            <option value="increasing">TƒÉng d·∫ßn</option>
            <option value="spike">TƒÉng ƒë·ªôt bi·∫øn</option>
            <option value="random">Ng·∫´u nhi√™n</option>
          </select>
        </div>
        
        <div class="bg-light p-3 rounded mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small class="text-muted">Gi√° tr·ªã hi·ªán t·∫°i:</small>
            <strong id="electricCurrent">0 kW</strong>
          </div>
          <div class="d-flex justify-content-between mb-1">
            <small class="text-muted">S·ªë l·∫ßn g·ª≠i:</small>
            <strong id="electricCount">0</strong>
          </div>
          <div class="d-flex justify-content-between">
            <small class="text-muted">L·∫ßn cu·ªëi:</small>
            <strong id="electricLast">-</strong>
          </div>
        </div>
        
        <canvas id="electricChart" height="100"></canvas>
      </div>
    </div>
  </div>

  <!-- Simulator 2: C·∫£m bi·∫øn n∆∞·ªõc -->
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-droplet"></i> C·∫£m bi·∫øn N∆∞·ªõc
          </h5>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="waterSimulator" onchange="toggleSimulator('water')">
            <label class="form-check-label text-white">B·∫≠t/T·∫Øt</label>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label small">Device ID</label>
            <input type="text" class="form-control form-control-sm" value="WF-S001" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label small">Ph√≤ng</label>
            <select class="form-select form-select-sm">
              <option>Ph√≤ng 101</option>
              <option>Ph√≤ng 102</option>
              <option>Ph√≤ng 201</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label small">L∆∞u l∆∞·ª£ng (L/h)</label>
            <input type="number" class="form-control form-control-sm" id="waterValue" value="150" step="10">
          </div>
          <div class="col-md-6">
            <label class="form-label small">T·∫ßn su·∫•t (gi√¢y)</label>
            <input type="number" class="form-control form-control-sm" id="waterInterval" value="5" min="1">
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label small">Ch·∫ø ƒë·ªô m√¥ ph·ªèng</label>
          <select class="form-select form-select-sm" id="waterMode">
            <option value="normal">B√¨nh th∆∞·ªùng</option>
            <option value="leak">R√≤ r·ªâ (2500 L/h)</option>
            <option value="high">Ti√™u th·ª• cao</option>
            <option value="random">Ng·∫´u nhi√™n</option>
          </select>
        </div>
        
        <div class="bg-light p-3 rounded mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small class="text-muted">L∆∞u l∆∞·ª£ng hi·ªán t·∫°i:</small>
            <strong id="waterCurrent">0 L/h</strong>
          </div>
          <div class="d-flex justify-content-between mb-1">
            <small class="text-muted">S·ªë l·∫ßn g·ª≠i:</small>
            <strong id="waterCount">0</strong>
          </div>
          <div class="d-flex justify-content-between">
            <small class="text-muted">L·∫ßn cu·ªëi:</small>
            <strong id="waterLast">-</strong>
          </div>
        </div>
        
        <canvas id="waterChart" height="100"></canvas>
      </div>
    </div>
  </div>

  <!-- Simulator 3: C·∫£m bi·∫øn nhi·ªát ƒë·ªô -->
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-danger text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-thermometer"></i> C·∫£m bi·∫øn Nhi·ªát ƒë·ªô
          </h5>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="tempSimulator" onchange="toggleSimulator('temp')">
            <label class="form-check-label text-white">B·∫≠t/T·∫Øt</label>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label small">Device ID</label>
            <input type="text" class="form-control form-control-sm" value="DHT22-T001" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label small">Ph√≤ng</label>
            <select class="form-select form-select-sm">
              <option>Ph√≤ng 101</option>
              <option>Ph√≤ng 102</option>
              <option>Ph√≤ng 201</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label small">Nhi·ªát ƒë·ªô (¬∞C)</label>
            <input type="number" class="form-control form-control-sm" id="tempValue" value="28" step="0.5">
          </div>
          <div class="col-md-6">
            <label class="form-label small">ƒê·ªô ·∫©m (%)</label>
            <input type="number" class="form-control form-control-sm" id="humidityValue" value="65" step="1">
          </div>
        </div>
        
        <div class="bg-light p-3 rounded mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small class="text-muted">Nhi·ªát ƒë·ªô:</small>
            <strong id="tempCurrent">0¬∞C</strong>
          </div>
          <div class="d-flex justify-content-between mb-1">
            <small class="text-muted">ƒê·ªô ·∫©m:</small>
            <strong id="humidityCurrent">0%</strong>
          </div>
          <div class="d-flex justify-content-between">
            <small class="text-muted">S·ªë l·∫ßn g·ª≠i:</small>
            <strong id="tempCount">0</strong>
          </div>
        </div>
        
        <canvas id="tempChart" height="100"></canvas>
      </div>
    </div>
  </div>

  <!-- Log console -->
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-terminal"></i> Console Log
        </h5>
        <button class="btn btn-sm btn-outline-light" onclick="clearLog()">
          <i class="bi bi-trash"></i> Clear
        </button>
      </div>
      <div class="card-body p-0">
        <div id="logConsole" class="p-3 bg-dark text-light font-monospace" style="height: 400px; overflow-y: auto; font-size: 12px;">
          <div class="text-success">IoT Simulator ready...</div>
          <div class="text-muted">Waiting for commands...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Simulators state
const simulators = {
  electric: { active: false, interval: null, count: 0, data: [] },
  water: { active: false, interval: null, count: 0, data: [] },
  temp: { active: false, interval: null, count: 0, data: [] }
};

// Charts
let electricChart, waterChart, tempChart;

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
  electricChart = createChart('electricChart', 'ƒêi·ªán (kW)', 'rgba(255, 193, 7, 0.7)');
  waterChart = createChart('waterChart', 'N∆∞·ªõc (L/h)', 'rgba(13, 110, 253, 0.7)');
  tempChart = createChart('tempChart', 'Nhi·ªát ƒë·ªô (¬∞C)', 'rgba(220, 53, 69, 0.7)');
});

function createChart(canvasId, label, color) {
  const ctx = document.getElementById(canvasId);
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: label,
        data: [],
        borderColor: color,
        backgroundColor: color,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        x: { display: false },
        y: { beginAtZero: true }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
}

function toggleSimulator(type) {
  const checkbox = document.getElementById(`${type}Simulator`);
  
  if (checkbox.checked) {
    startSimulator(type);
  } else {
    stopSimulator(type);
  }
}

function startSimulator(type) {
  if (simulators[type].active) return;
  
  simulators[type].active = true;
  log(`‚úÖ Started ${type} simulator`, 'success');
  
  const interval = document.getElementById(`${type}Interval`)?.value || 5;
  
  simulators[type].interval = setInterval(() => {
    sendData(type);
  }, interval * 1000);
  
  // Send first data immediately
  sendData(type);
}

function stopSimulator(type) {
  if (!simulators[type].active) return;
  
  simulators[type].active = false;
  clearInterval(simulators[type].interval);
  log(`‚èπÔ∏è Stopped ${type} simulator`, 'warning');
}

function sendData(type) {
  let value, unit, deviceId;
  
  switch(type) {
    case 'electric':
      const eMode = document.getElementById('electricMode').value;
      const eBase = parseFloat(document.getElementById('electricValue').value);
      
      if (eMode === 'spike') {
        value = eBase * (Math.random() * 3 + 1); // 1x to 4x
      } else if (eMode === 'increasing') {
        value = eBase + (simulators[type].count * 0.1);
      } else if (eMode === 'random') {
        value = eBase * (Math.random() * 0.5 + 0.75); // 75% to 125%
      } else {
        value = eBase + (Math.random() * 0.5 - 0.25);
      }
      
      unit = 'kW';
      deviceId = 'ESP32-E001';
      document.getElementById('electricCurrent').textContent = value.toFixed(2) + ' ' + unit;
      updateChart(electricChart, value);
      break;
      
    case 'water':
      const wMode = document.getElementById('waterMode').value;
      const wBase = parseFloat(document.getElementById('waterValue').value);
      
      if (wMode === 'leak') {
        value = 2500; // Simulate leak
      } else if (wMode === 'high') {
        value = wBase * 2;
      } else if (wMode === 'random') {
        value = wBase * (Math.random() * 0.8 + 0.6);
      } else {
        value = wBase + (Math.random() * 50 - 25);
      }
      
      unit = 'L/h';
      deviceId = 'WF-S001';
      document.getElementById('waterCurrent').textContent = value.toFixed(0) + ' ' + unit;
      updateChart(waterChart, value);
      break;
      
    case 'temp':
      const tBase = parseFloat(document.getElementById('tempValue').value);
      const hBase = parseFloat(document.getElementById('humidityValue').value);
      
      value = tBase + (Math.random() * 2 - 1);
      const humidity = hBase + (Math.random() * 5 - 2.5);
      
      unit = '¬∞C';
      deviceId = 'DHT22-T001';
      document.getElementById('tempCurrent').textContent = value.toFixed(1) + '¬∞C';
      document.getElementById('humidityCurrent').textContent = humidity.toFixed(0) + '%';
      updateChart(tempChart, value);
      break;
  }
  
  // Update counter
  simulators[type].count++;
  document.getElementById(`${type}Count`).textContent = simulators[type].count;
  document.getElementById(`${type}Last`).textContent = new Date().toLocaleTimeString();
  
  // Send to API (demo)
  const data = {
    device_id: deviceId,
    type: type,
    value: value,
    unit: unit,
    timestamp: new Date().toISOString()
  };
  
  log(`üì§ [${type.toUpperCase()}] Sent: ${value.toFixed(2)} ${unit}`, 'info');
  
  // Simulate API call
  // fetch('/api/iot/readings', {
  //   method: 'POST',
  //   headers: { 'Content-Type': 'application/json' },
  //   body: JSON.stringify(data)
  // });
}

function updateChart(chart, value) {
  chart.data.labels.push('');
  chart.data.datasets[0].data.push(value);
  
  // Keep only last 20 points
  if (chart.data.labels.length > 20) {
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  
  chart.update();
}

function startAllSimulators() {
  document.getElementById('electricSimulator').checked = true;
  document.getElementById('waterSimulator').checked = true;
  document.getElementById('tempSimulator').checked = true;
  
  startSimulator('electric');
  startSimulator('water');
  startSimulator('temp');
  
  log('üöÄ All simulators started', 'success');
}

function stopAllSimulators() {
  document.getElementById('electricSimulator').checked = false;
  document.getElementById('waterSimulator').checked = false;
  document.getElementById('tempSimulator').checked = false;
  
  stopSimulator('electric');
  stopSimulator('water');
  stopSimulator('temp');
  
  log('üõë All simulators stopped', 'warning');
}

function log(message, type = 'info') {
  const console = document.getElementById('logConsole');
  const time = new Date().toLocaleTimeString();
  const colors = {
    success: 'text-success',
    warning: 'text-warning',
    info: 'text-info',
    error: 'text-danger'
  };
  
  const line = `<div class="${colors[type]}">[${time}] ${message}</div>`;
  console.innerHTML += line;
  console.scrollTop = console.scrollHeight;
}

function clearLog() {
  document.getElementById('logConsole').innerHTML = '<div class="text-success">Console cleared...</div>';
}
</script>

<style>
.form-check-input:checked {
  background-color: #198754;
  border-color: #198754;
}
</style>

{% endblock %}